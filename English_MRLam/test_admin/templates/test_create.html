{% extends 'base-admin.html' %}
{% load static %}

{% block title %}
  Thêm Mới Bài Kiểm Tra
{% endblock %}

{% block content %}
<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background-color: #f8f9fa;
}
.container {
  max-width: 100%;
  margin: 0 auto;
}
h2 {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 1rem;
}
.custom-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #5c6bc0;
        border-bottom: 2px solid;
        margin: 1.5rem 0 1rem;
        padding: 8px 0;
    }
/* Tab styling */
.nav-tabs {
  border-bottom: 2px solid #e9ecef;
  margin-bottom: 1.5rem;
}

/* Tab không active (màu xám) */
.nav-tabs .nav-link {
  border: none;
  padding: 0.75rem 1.25rem;
  font-size: 1rem;
  font-weight: 500;
  color: #6c757d; /* Màu xám */
  background-color: transparent;
  transition: all 0.2s ease;
  border-bottom: 3px solid transparent; /* Ẩn gạch chân */
}

/* Tab active (màu xanh) */
.nav-tabs .nav-link.active {
  color: #0d6efd !important; /* Màu xanh */
  font-weight: 600;
  border-bottom: 3px solid #0d6efd; /* Gạch chân xanh */
}

/* Hiệu ứng hover */
.nav-tabs .nav-link:hover {
  color: #0a58ca; /* Màu xanh đậm hơn */
}
.test-container {
  padding: 20px;
  background-color: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 8px;
}
.question {
  margin-bottom: 20px;
  padding: 15px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #ddd;
}
.test-footer, .button-group {
  text-align: right;
  margin-top: 20px;
}
.test-footer button, .button-group button {
  padding: 10px 20px;
  font-size: 1.1em;
}
.delete-checkbox {
  margin-top: 10px;
}
</style>

<div class="container">
  <h2 class="custom-title">Thêm Mới Bài Kiểm Tra</h2>
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a href="{% url 'admin_test_list' %}" class="nav-link active" role="tab">Bài kiểm tra</a>
        </li>
        <li class="nav-item">
            <a href="{% url 'results' %}" class="nav-link" role="tab">Kết quả</a>
        </li>
    </ul>
  <form method="POST" id="test-form">
    {% csrf_token %}
    <div class="test-container">
      <div class="form-group">
        <label for="{{ test_form.test_name.id_for_label }}"><strong>Tên bài kiểm tra:</strong></label>
        {{ test_form.test_name }}
        {{ test_form.test_name.errors }}
      </div>
      <div class="form-group">
        <label for="{{ test_form.test_description.id_for_label }}"><strong>Mô tả:</strong></label>
        {{ test_form.test_description }}
        {{ test_form.test_description.errors }}
      </div>
      <div class="form-group">
        <label for="{{ test_form.duration.id_for_label }}"><strong>Thời gian (HH:MM):</strong></label>
        {{ test_form.duration }}
        {{ test_form.duration.errors }}
      </div>

      <hr>
      <h4>Danh sách câu hỏi</h4>

      <div class="question-container">
        {{ question_formset.management_form }}
        {% for form in question_formset %}
        <div class="question" id="question-{{ forloop.counter }}">
          <p><strong>Câu {{ forloop.counter }}:</strong></p>
          {{ form.non_field_errors }}

          <div class="form-group">
            {{ form.question_text.label_tag }}
            {{ form.question_text }}
          </div>
          <div class="form-group">
            {{ form.answer_a.label_tag }}
            {{ form.answer_a }}
          </div>
          <div class="form-group">
            {{ form.answer_b.label_tag }}
            {{ form.answer_b }}
          </div>
          <div class="form-group">
            {{ form.answer_c.label_tag }}
            {{ form.answer_c }}
          </div>
          <div class="form-group">
            {{ form.answer_d.label_tag }}
            {{ form.answer_d }}
          </div>
          <div class="form-group">
            {{ form.correct_answer.label_tag }}
            {{ form.correct_answer }}
          </div>
          <div class="form-group">
            {{ form.link_audio.label_tag }}
            {{ form.link_audio }}
          </div>
          <div class="form-group">
            {{ form.paragraph.label_tag }}
            {{ form.paragraph }}
          </div>

          <div class="delete-checkbox">
            {{ form.DELETE.label_tag }} {{ form.DELETE }}
          </div>
        </div>
        {% endfor %}
        <button type="button" id="add-question" class="btn btn-success">+ Thêm câu hỏi</button>
      </div>

      <div class="button-group">
        <button type="submit" class="btn btn-primary">Lưu</button>
        <a href="{% url 'admin_test_list' %}" class="btn btn-secondary">Hủy</a>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const addQuestionButton = document.getElementById('add-question');
  const questionContainer = document.querySelector('.question-container');
  const totalForms = document.getElementById('id_questions-TOTAL_FORMS');
  let formCount = parseInt(totalForms.value);

  addQuestionButton.addEventListener('click', function () {
    const lastForm = document.querySelector('.question:last-child');
    const newForm = lastForm.cloneNode(true);
    formCount++;
    totalForms.value = formCount;

    // Cập nhật tên/id các trường
    newForm.innerHTML = newForm.innerHTML.replace(/questions-(\d+)-/g, `questions-${formCount - 1}-`);
    newForm.querySelectorAll('input, textarea').forEach(input => {
      if (input.type === 'checkbox') {
        input.checked = false;
      } else {
        input.value = '';
      }
    });
    newForm.querySelector('p').textContent = `Câu ${formCount}:`;
    newForm.id = `question-${formCount}`;

    questionContainer.insertBefore(newForm, addQuestionButton);
  });
});
</script>
{% endblock %}
